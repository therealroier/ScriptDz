local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

ESP = ESP or {
    Enabled = true,
    TeamCheck = true,
    ShowBoxes = true,
    ShowNames = true,
    ShowTracers = true,
    ShowHealth = true,
    HealthColorMode = "custom",
    HealthColorFunction = function(healthPercent)
        if healthPercent > 0.7 then
            return Color3.fromRGB(0, 255, 0)
        elseif healthPercent > 0.3 then
            return Color3.fromRGB(255, 165, 0)
        else
            return Color3.fromRGB(255, 0, 0)
        end
    end
}

local ESPObjects = {}

local function newDrawing(type, props)
    local obj = Drawing.new(type)
    for k, v in pairs(props) do
        obj[k] = v
    end
    return obj
end

local function createESPElements()
    return {
        BoxOutline = newDrawing("Square", {Visible = false, Thickness = 2, Filled = false, Color = Color3.new(0,0,0)}),
        Box = newDrawing("Square", {Visible = false, Thickness = 1, Filled = false}),
        Name = newDrawing("Text", {Visible = false, Center = true, Outline = true, Size = 16, Font = 2}),
        TracerOutline = newDrawing("Line", {Visible = false, Thickness = 2.5, Color = Color3.new(0,0,0)}),
        Tracer = newDrawing("Line", {Visible = false, Thickness = 1}),
        HealthBarOutline = newDrawing("Line", {Visible = false, Thickness = 4, Color = Color3.new(0,0,0)}),
        HealthBar = newDrawing("Line", {Visible = false, Thickness = 2})
    }
end

local function hideAll(data)
    data.Box.Visible = false
    data.BoxOutline.Visible = false
    data.Name.Visible = false
    data.Tracer.Visible = false
    data.TracerOutline.Visible = false
    data.HealthBar.Visible = false
    data.HealthBarOutline.Visible = false
end

RunService.RenderStepped:Connect(function()
    if not ESP.Enabled then
        for _, data in pairs(ESPObjects) do
            hideAll(data)
        end
        return
    end

    local screenCenter = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if ESP.TeamCheck and player.Team == LocalPlayer.Team then
                if ESPObjects[player] then
                    hideAll(ESPObjects[player])
                end
                continue
            end

            local character = player.Character
            local hrp = character and character:FindFirstChild("HumanoidRootPart")
            local humanoid = character and character:FindFirstChildOfClass("Humanoid")

            if character and hrp and humanoid and humanoid.Health > 0 then
                local hrpPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                
                if onScreen then
                    local teamColor = player.TeamColor.Color
                    local scale = 1 / (hrpPos.Z * math.tan(math.rad(Camera.FieldOfView * 0.5)) * 2) * 1000
                    local width, height = 4 * scale, 6 * scale
                    local boxPos = Vector2.new(hrpPos.X - width / 2, hrpPos.Y - height / 2)
                    
                    local data = ESPObjects[player] or createESPElements()
                    ESPObjects[player] = data

                    local healthRatio = math.clamp(humanoid.Health / humanoid.MaxHealth, 0, 1)

                    if ESP.ShowBoxes then
                        data.BoxOutline.Visible = true
                        data.BoxOutline.Position = boxPos
                        data.BoxOutline.Size = Vector2.new(width, height)
                        
                        data.Box.Visible = true
                        data.Box.Position = boxPos
                        data.Box.Size = Vector2.new(width, height)
                        data.Box.Color = teamColor
                    else
                        data.BoxOutline.Visible = false
                        data.Box.Visible = false
                    end

                    if ESP.ShowNames then
                        data.Name.Visible = true
                        data.Name.Text = player.Name
                        data.Name.Position = Vector2.new(hrpPos.X, boxPos.Y - 20)
                        data.Name.Color = teamColor
                    else
                        data.Name.Visible = false
                    end

                    if ESP.ShowTracers then
                        data.TracerOutline.Visible = true
                        data.TracerOutline.From = screenCenter
                        data.TracerOutline.To = Vector2.new(hrpPos.X, boxPos.Y + height)

                        data.Tracer.Visible = true
                        data.Tracer.From = screenCenter
                        data.Tracer.To = Vector2.new(hrpPos.X, boxPos.Y + height)
                        data.Tracer.Color = teamColor
                    else
                        data.TracerOutline.Visible = false
                        data.Tracer.Visible = false
                    end

                    if ESP.ShowHealth then
                        local barHeight = height * healthRatio
                        local barPos = Vector2.new(boxPos.X - 6, boxPos.Y + height)
                        
                        data.HealthBarOutline.Visible = true
                        data.HealthBarOutline.From = barPos
                        data.HealthBarOutline.To = Vector2.new(barPos.X, boxPos.Y)

                        data.HealthBar.Visible = true
                        data.HealthBar.Color = ESP.HealthColorFunction(healthRatio)
                        data.HealthBar.From = barPos
                        data.HealthBar.To = Vector2.new(barPos.X, barPos.Y - barHeight)
                    else
                        data.HealthBarOutline.Visible = false
                        data.HealthBar.Visible = false
                    end
                else
                    if ESPObjects[player] then
                        hideAll(ESPObjects[player])
                    end
                end
            else
                if ESPObjects[player] then
                    hideAll(ESPObjects[player])
                end
            end
        end
    end
end)

Players.PlayerRemoving:Connect(function(player)
    if ESPObjects[player] then
        for _, obj in pairs(ESPObjects[player]) do
            obj:Remove()
        end
        ESPObjects[player] = nil
    end
end)
